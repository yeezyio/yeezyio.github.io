<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EEPROMCutter @yeezyio</title>
    <link rel="shortcut icon" href="favicon.jpg" type="image/x-icon">
    <link rel="stylesheet" href="fonts/google-sans.css" />
    <style>
      body {
        margin: 0;
        background: #1f1f1f;
        color: #e3e3e3;
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        vertical-align: middle;
      }
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 50px;
        flex-direction: column;
      }
      .flag {
        height: 30px;
        width: 50px;
        margin-left: 10px;
        margin-right: 10px;
        background-image: linear-gradient(#fff 33.3%, #00f 33.3% 66.6%, #f00 66.6% 100%);
      }
      #blockpowered {
        display: flex;
        font-size: 2rem;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      #blockpoweredWARN {
        font-size: 2rem;
        margin-bottom: 25px;
      }
      a {
        text-decoration: none;
        color: #c2e7ff;
        transition: 0.1s linear;
      }
      a:hover {
        color: #004a77;
      }
      h1 {
        font-weight: normal;
        margin: 20px;
      }
      #content {
        background: #28292a;
        padding: 50px;
        border-radius: 50px;
      }
      #info {
        background: #2d2f31;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #file {
        display: none;
      }
      label {
        padding: 15px;
        background-color: #a8c7fa;
        border-radius: 50px;
        color: #062e6f;
        text-transform: uppercase;
        transition: 0.1s linear;
      }
      label:hover {
        background-color: #c0d4f7;
      }
      #error {
        background: #601410;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #f2b8b5;
        display: none;
      }
      #success {
        display: flex;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        background: #015309;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #42e345;
        display: none;
      }
      .icons {
        margin-right: 10px;
      }
      input {
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        color: white;
        background: #36343b;
        border-radius: 5px;
        padding: 10px;
        font-size: 1.3rem;
        border-bottom: 3px solid #938f99;
      }
      #inputContainer {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }
      button {
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        padding: 15px;
        background-color: #a8c7fa;
        border-radius: 50px;
        color: #062e6f;
        text-transform: uppercase;
        transition: 0.1s linear;
      }
      button:hover {
        background-color: #c0d4f7;
      }
      details > summary {
        list-style: none;
      }
      summary {
        color: #c2e7ff;
        font-size: 1.2rem;
      }
      details {
        font-size: 1.2rem;
      }
      summary:hover {
        transition: 0.1s linear;
        color: #004a77;
      }
      details summary:before {
        transition: 0.1s linear;
        content: "+";
        margin-right: 7px;
        font-weight: 600;
      }
      details[open] summary:before {
        transition: 0.1s linear;
        content: "-";
      }
      #info2 {
        background: #2d2f31;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #process {
        display: none;
        background: #3f3f3f;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #output {
        background: #015309;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        padding-top: 20px;
        padding-bottom: 20px;
        margin: 40px;
        color: #42e345;
        display: none;
      }
      #outputerror {
        display: none;
        background: #601410;
        padding: 10px;
        padding-top: 20px;
        padding-bottom: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #f2b8b5;
      }
      .warning {
        color: rgb(206, 41, 41);
      }
      @media screen and (max-width: 1114px) {
        #blockpoweredWARN {
          font-size: 1.5rem;
        }
        #blockpowered {
          font-size: 1.5rem;
        }
        #choice {
          flex-direction: column;
        }
        h1 {
          font-size: 1.3rem;
        }
        hr {
          width: 80%;
          height: 1px;
        }
        button {
          margin: 20px;
          font-size: 1rem;
        }
        button:hover {
          font-size: 1.5rem;
        }
        label {
          margin: 20px;
          font-size: 1rem;
        }
        #info {
          font-size: 1.3rem;
        }
        #infoup {
          font-size: 1.3rem;
        }
        #error {
          font-size: 1.3rem;
        }
        #success {
          font-size: 1.3rem;
        }
        #output {
          font-size: 1.3rem;
        }
        #outputerror {
          font-size: 1.3rem;
        }
        #process {
          font-size: 1.3rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <div id="blockpowered">
        <div>Сделано в России</div>
        <div class="flag"></div>
        <div><a href="https://t.me/yeezyio">@yeezyio</a></div>
      </div>
      <div id="blockpoweredWARN">
        <span class="warning">Все действия на Ваш страх и риск</span>
      </div>
      <div id="content">
        <h1>Вырезалка EEPROM из полного дампа <a href="https://breed.hackpascal.net/">Breed</a></h1>
        <div id="info">
          Выберите полный дамп снятый с помощью Breed
        </div>
        <div id="process">Идёт поиск...</div>
        <div id="output">Файл успешно сгенерирован<br /></div>
        <div id="outputerror">
          В вашем файле не были найдены чипы Wi-Fi<br />Скорее всего, вы затерли свои калибровки, либо ваши чипы не поддерживаются, что маловерятно
        </div>

        <div id="loadingContainer" class="hidden">
          <label for="file">Выбрать файл</label>
          <input type="file" id="file" name="file" accept=".bin" />
        </div>
      </div>
    </main>
<script>
  class NameUnit {
    real;
    fake;
    constructor(real, fake) {
      if (arguments.length == 1) {
        this.real = real;
        this.fake = real;
      } else {
        this.real = real;
        this.fake = fake;
      }
    }
  }

  const gens = [
    new NameUnit(0x28),
    new NameUnit(0x03),
    new NameUnit(0x63, 0x13),
    new NameUnit(0x15),
    new NameUnit(0x62, 0x12),
  ];
  const models = [new NameUnit(0x76)];

  function findChips(intArray, startIndex = 0, endIndex = null) {
    const result = [];
    const signatures = new Map();

    signatures.set((0x15 << 8) | 0x79, {gen: new NameUnit(0x15), model: new NameUnit(0x79)});

    for (const gen of gens) {
      for (const model of models) {
        const signature = (gen.real << 8) | model.real;
        signatures.set(signature, {gen, model});
      }
    }

    const searchEnd = endIndex !== null ? endIndex : intArray.length - 1;
    console.log(`Поиск чипов в диапазоне ${startIndex} - ${searchEnd}`);

    for (let index = startIndex; index < searchEnd; index++) {
      const currentPair = (intArray[index] << 8) | intArray[index + 1];
      if (signatures.has(currentPair)) {
        let flag = true;
        if (index !== 0) {
          if (index < 30) {
            flag = false;
          } else {
            for (let sIndex = index - 1; sIndex >= index - 30; sIndex--) {
              if (intArray[sIndex] !== 0xff && intArray[sIndex] !== 0x00) {
                flag = false;
                break;
              }
            }
          }
        }
        if (flag) {
          const {gen, model} = signatures.get(currentPair);
          const chipId = `${model.real.toString(16).padStart(2, "0")}${gen.real.toString(16).padStart(2, "0")}`;
          console.log(`Найден чип ${chipId} по смещению 0x${index.toString(16)}`);
          result.push({index, gen, model, chipId});
        }
      }
    }
    console.log(`Всего найдено чипов: ${result.length}`);
    return result;
  }

  function searchBytes(intArray, processedRanges) {
    const result = [];
    const foundChips = findChips(intArray);

    for (const chip of foundChips) {
      let isProcessed = false;
      for (const [start, end] of processedRanges) {
        if (chip.index >= start && chip.index < end) {
          isProcessed = true;
          break;
        }
      }
      if (!isProcessed) {
        result.push(chip);
      }
    }
    return result;
  }

  function findSecondChip(intArray) {
    const signatures = new Map();
    for (const gen of gens) {
      for (const model of models) {
        const signature = (gen.real << 8) | model.real;
        signatures.set(signature, {gen, model});
      }
    }

    let foundFirst = false;
    for (let index = 0; index < intArray.length - 1; index++) {
      const currentPair = (intArray[index] << 8) | intArray[index + 1];
      if (signatures.has(currentPair)) {
        let flag = true;
        for (let sIndex = index - 1; sIndex >= index - 4; sIndex--) {
          if (sIndex < 0 || intArray[sIndex] !== 0xff) {
            flag = false;
            break;
          }
        }
        if (flag) {
          if (!foundFirst) {
            foundFirst = true; // Пропускаем первый чип на 0x0
          } else {
            return index; // Нашли второй чип с 0xFF перед ним
          }
        }
      }
    }
    return -1; // Если второго чипа нет
  }

  function analyzeEepromBlock(dataView) {
    const intArray = new Uint8Array(dataView.buffer);
    const foundChips = findChips(intArray, 0, intArray.length);
    return foundChips.map(chip => chip.chipId);
  }

  function makeEeprom(offset, arrayBuffer) {
    const copyLength = (arrayBuffer.byteLength === 16777216 || arrayBuffer.byteLength === 33554432) ? 0x10000 : 0x80000; // 64 КБ для 16/32 МБ файла, иначе 512 КБ
    const blockLength = 0x1000; // 4 КБ для второго чипа
    const targetOffset = 0x8000; // Смещение для второго чипа
    const dataView = new DataView(arrayBuffer);
    const outputArrayBuffer = new ArrayBuffer(copyLength);
    const outputDataView = new DataView(outputArrayBuffer);

    for (let i = 0; i < copyLength && i + offset < arrayBuffer.byteLength; i++) {
      outputDataView.setUint8(i, dataView.getUint8(i + offset));
    }

    // Ищем второй чип в блоке с учётом 0xFF
    const intArray = new Uint8Array(outputArrayBuffer);
    const secondChipOffset = findSecondChip(intArray);

    if (secondChipOffset !== -1 && secondChipOffset !== targetOffset) {
      // Если второй чип найден и не на 0x8000, переносим его на 0x8000 с заменой
      for (let i = 0; i < blockLength && secondChipOffset + i < intArray.length; i++) {
        outputDataView.setUint8(targetOffset + i, intArray[secondChipOffset + i]);
      }
    }

    return outputDataView;
  }

  function areEepromsIdentical(eeprom1, eeprom2) {
    const array1 = new Uint8Array(eeprom1.buffer);
    const array2 = new Uint8Array(eeprom2.buffer);

    if (array1.length !== array2.length) return false;

    for (let i = 0; i < array1.length; i++) {
      if (array1[i] !== array2[i]) return false;
    }

    return true;
  }

  function download(dataView, index, totalEeproms) {
    const blob = new Blob([dataView], { type: "application/octet-stream" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    // Добавляем индекс только если найдено больше одного EEPROM'а
    link.download = totalEeproms > 1 ? `eeprom_${index + 1}.bin` : 'eeprom.bin';
    link.click();
    URL.revokeObjectURL(url);
  }

  const handleClick = async (evt) => {
    document.getElementById("info").style.display = "none";
    document.getElementById("loadingContainer").style.display = "none";
    document.getElementById("process").style.display = "block";
    const file = evt.target.files[0];
    const reader = new FileReader();
    reader.onload = async () => {
      const arrayBuffer = reader.result;
      const intArray = new Uint8Array(arrayBuffer);
      const processedRanges = [];
      const eeproms = [];
      const uniqueEeproms = [];

      while (true) {
        const found = searchBytes(intArray, processedRanges);
        if (found.length === 0) break;

        const {index: offset} = found[0];
        console.log(`Обработка EEPROM по смещению 0x${offset.toString(16)}`);
        const eepromData = makeEeprom(offset, arrayBuffer);
        const chips = analyzeEepromBlock(eepromData);
        console.log(`Найденные чипы в EEPROM: ${chips.join(", ")}`);

        // Проверяем, является ли этот EEPROM уникальным
        let isUnique = true;
        for (const existingEeprom of uniqueEeproms) {
          if (areEepromsIdentical(eepromData, existingEeprom.data)) {
            isUnique = false;
            break;
          }
        }

        if (isUnique) {
          uniqueEeproms.push({
            data: eepromData,
            chips: chips,
            originalIndex: eeproms.length
          });
        }

        eeproms.push({fileIndex: eeproms.length, chips});
        processedRanges.push([offset, offset + 0x80000]);
      }

      document.getElementById("process").style.display = "none";
      document.getElementById("output").style.display = "block";

      if (eeproms.length === 0) {
        document.getElementById("output").style.display = "none";
        document.getElementById("outputerror").style.display = "block";
      } else if (uniqueEeproms.length === 1) {
        const chipsText = uniqueEeproms[0].chips.length > 0 ? uniqueEeproms[0].chips.join("/") : "Чипы не найдены";
        console.log(`Отображение чипов для единственного EEPROM: ${chipsText}`);
        document.getElementById("output").innerHTML += `Найден чип: ${chipsText}`;
        // Скачиваем файл после показа сообщения
        download(uniqueEeproms[0].data, 0, uniqueEeproms.length);
      } else {
        let outputText = "Найдено несколько EEPROM:<br><br>";
        uniqueEeproms.forEach((eeprom, index) => {
          const chipsText = eeprom.chips.length > 0 ? eeprom.chips.join("/") : "Чипы не найдены";
          console.log(`Отображение чипов для EEPROM ${index + 1}: ${chipsText}`);
          outputText += `eeprom_${index + 1}.bin:<br>${chipsText}<br><br>`;
        });
        if (uniqueEeproms.length < eeproms.length) {
          outputText += `<br>Примечание: ${eeproms.length - uniqueEeproms.length} дубликатов EEPROM были пропущены`;
        }
        document.getElementById("output").innerHTML += outputText;

        // Скачиваем файлы после показа сообщения
        uniqueEeproms.forEach((eeprom, index) => {
          setTimeout(() => download(eeprom.data, index, uniqueEeproms.length), 500 * index);
        });
      }
    };

    reader.readAsArrayBuffer(file);
  };

  document.getElementById("file").addEventListener("change", handleClick, false);
</script>

    <div><a href="https://yeezyio.github.io/">Вернуться на главную страницу</a></div>
  </body>
</html>
