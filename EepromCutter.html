<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EEPROMCutter @yeezyio</title>
    <link rel="shortcut icon" href="favicon.jpg" type="image/x-icon">
    <link rel="stylesheet" href="fonts/google-sans.css" />
    <style>
      body {
        margin: 0;
        background: #1f1f1f;
        color: #e3e3e3;
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        vertical-align: middle;
      }
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        gap: 50px;
        flex-direction: column;
      }
      .flag {
        height: 30px;
        width: 50px;
        margin-left: 10px;
        margin-right: 10px;
        background-image: linear-gradient(#fff 33.3%, #00f 33.3% 66.6%, #f00 66.6% 100%);
      }
      #blockpowered {
        display: flex;
        font-size: 2rem;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }
      #blockpoweredWARN {
        font-size: 2rem;
        margin-bottom: 25px;
      }
      a {
        text-decoration: none;
        color: #c2e7ff;
        transition: 0.1s linear;
      }
      a:hover {
        color: #004a77;
      }
      h1 {
        font-weight: normal;
        margin: 20px;
      }
      #content {
        background: #28292a;
        padding: 50px;
        border-radius: 50px;
      }
      #info {
        background: #2d2f31;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #file {
        display: none;
      }
      label {
        padding: 15px;
        background-color: #a8c7fa;
        border-radius: 50px;
        color: #062e6f;
        text-transform: uppercase;
        transition: 0.1s linear;
      }
      label:hover {
        background-color: #c0d4f7;
      }
      #error {
        background: #601410;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #f2b8b5;
        display: none;
      }
      #success {
        display: flex;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        background: #015309;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #42e345;
        display: none;
      }
      .icons {
        margin-right: 10px;
      }
      input {
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        color: white;
        background: #36343b;
        border-radius: 5px;
        padding: 10px;
        font-size: 1.3rem;
        border-bottom: 3px solid #938f99;
      }
      #inputContainer {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        flex-direction: column;
        justify-content: center;
        text-align: center;
      }
      button {
        font-family: "Product Sans Medium", Arial, Helvetica, sans-serif;
        padding: 15px;
        background-color: #a8c7fa;
        border-radius: 50px;
        color: #062e6f;
        text-transform: uppercase;
        transition: 0.1s linear;
      }
      button:hover {
        background-color: #c0d4f7;
      }
      details > summary {
        list-style: none;
      }
      summary {
        color: #c2e7ff;
        font-size: 1.2rem;
      }
      details {
        font-size: 1.2rem;
      }
      summary:hover {
        transition: 0.1s linear;
        color: #004a77;
      }
      details summary:before {
        transition: 0.1s linear;
        content: "+";
        margin-right: 7px;
        font-weight: 600;
      }
      details[open] summary:before {
        transition: 0.1s linear;
        content: "-";
      }
      #info2 {
        background: #2d2f31;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #process {
        display: none;
        background: #3f3f3f;
        padding: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
      }
      #output {
        background: #015309;
        padding: 10px;
        font-size: 1.5rem;
        border-radius: 50px;
        padding-top: 20px;
        padding-bottom: 20px;
        margin: 40px;
        color: #42e345;
        display: none;
      }
      #outputerror {
        display: none;
        background: #601410;
        padding: 10px;
        padding-top: 20px;
        padding-bottom: 20px;
        font-size: 1.5rem;
        border-radius: 50px;
        margin: 40px;
        color: #f2b8b5;
      }
      .warning {
        color: rgb(206, 41, 41);
      }
      @media screen and (max-width: 1114px) {
        #blockpoweredWARN {
          font-size: 1.5rem;
        }
        #blockpowered {
          font-size: 1.5rem;
        }
        #choice {
          flex-direction: column;
        }
        h1 {
          font-size: 1.3rem;
        }
        hr {
          width: 80%;
          height: 1px;
        }
        button {
          margin: 20px;
          font-size: 1rem;
        }
        button:hover {
          font-size: 1.5rem;
        }
        label {
          margin: 20px;
          font-size: 1rem;
        }
        #info {
          font-size: 1.3rem;
        }
        #infoup {
          font-size: 1.3rem;
        }
        #error {
          font-size: 1.3rem;
        }
        #success {
          font-size: 1.3rem;
        }
        #output {
          font-size: 1.3rem;
        }
        #outputerror {
          font-size: 1.3rem;
        }
        #process {
          font-size: 1.3rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <div id="blockpowered">
        <div>Сделано в России</div>
        <div class="flag"></div>
        <div><a href="https://t.me/yeezyio">@yeezyio</a></div>
      </div>
      <div id="blockpoweredWARN">
        <span class="warning">Все действия на Ваш страх и риск</span>
      </div>
      <div id="content">
        <h1>Вырезалка EEPROM из дампа</h1>
        <div id="info">
          Выберите полный дамп
        </div>
        <div id="process">Идёт поиск...</div>
        <div id="output">Файл успешно сгенерирован<br /></div>
        <div id="outputerror">
          В файле не найдены чипы Wi-Fi
        </div>

        <div id="loadingContainer" class="hidden">
          <label for="file">Выбрать файл</label>
          <input type="file" id="file" name="file" accept=".bin" />
        </div>
      </div>
    </main>
<script>
  const CHIP_SIGNATURES = new Map([
    [0x2876, { name: 'MT7628',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x0376, { name: 'MT7603',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x6276, { name: 'MT7612',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x6376, { name: 'MT7613',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x1576, { name: 'MT7615',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x1579, { name: 'MT7915',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x200 }],
    [0x8179, { name: 'MT7981',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x800,  factorySize: 0x200000 }],
    [0x9279, { name: 'MT7992',  macOffset: 0x04, calStart: 0x20,  calEnd: 0x800,  factorySize: 0x400000 }],
  ]);

  const ALIGN_4K = 0x1000;
  const SECOND_RADIO_OFFSET = 0x8000;

  function isValidMac(data, chipOffset, chipInfo) {
    const mOff = chipInfo.macOffset;
    if (chipOffset + mOff + 6 > data.length) return false;
    const mac = data.subarray(chipOffset + mOff, chipOffset + mOff + 6);
    if (mac.every(b => b === 0xFF) || mac.every(b => b === 0x00)) return false;
    if (mac[0] & 0x01) return false;
    return true;
  }

  function isValidVersion(data, chipOffset) {
    if (chipOffset + 3 > data.length) return false;
    const version = data[chipOffset + 2];
    return version <= 0x10;
  }

  function calcShannonEntropy(bytes) {
    if (!bytes.length) return 0;
    const freq = new Uint32Array(256);
    for (let i = 0; i < bytes.length; i++) freq[bytes[i]]++;

    let entropy = 0;
    for (let i = 0; i < 256; i++) {
      if (!freq[i]) continue;
      const p = freq[i] / bytes.length;
      entropy -= p * Math.log2(p);
    }
    return entropy;
  }

  function hasCalibrationData(data, chipOffset, chipInfo) {
    const start = chipOffset + chipInfo.calStart;
    const end = Math.min(chipOffset + chipInfo.calEnd, data.length);
    let nonEmpty = 0;
    let ffOrZero = 0;
    const unique = new Set();
    for (let i = start; i < end; i++) {
      if (data[i] !== 0xFF && data[i] !== 0x00) {
        nonEmpty++;
      } else {
        ffOrZero++;
      }
      unique.add(data[i]);
    }

    const span = end - start;
    if (span < 64) return false;

    const calSlice = data.subarray(start, end);
    const entropy = calcShannonEntropy(calSlice);
    const ffOrZeroRatio = ffOrZero / span;

    if (nonEmpty < 15 || unique.size < 6) return false;
    if (ffOrZeroRatio < 0.03) return false;
    if (entropy > 7.4) return false;

    return true;
  }

  function validateChip(data, offset, chipInfo) {
    if (!isValidVersion(data, offset)) return false;
    if (!isValidMac(data, offset, chipInfo)) return false;
    if (!hasCalibrationData(data, offset, chipInfo)) return false;
    const mOff = chipInfo.macOffset;
    const mac = Array.from(data.subarray(offset + mOff, offset + mOff + 6))
            .map(b => b.toString(16).padStart(2, '0')).join(':');
    console.log(`  ✓ Валидный: ${chipInfo.name} @ 0x${offset.toString(16)} (MAC: ${mac})`);
    return true;
  }

  function findValidChips(data) {
    const chips = [];
    for (let offset = 0; offset < data.length - 1; offset += ALIGN_4K) {
      const sig = (data[offset] << 8) | data[offset + 1];
      const chipInfo = CHIP_SIGNATURES.get(sig);
      if (!chipInfo) continue;
      if (validateChip(data, offset, chipInfo)) {
        chips.push({ offset, chipInfo });
      }
    }
    console.log(`Всего валидных чипов: ${chips.length}`);
    return chips;
  }

  function groupIntoPartitions(chips, dumpSize) {
    if (chips.length === 0) return [];

    const defaultFactorySize = dumpSize <= 0x2000000 ? 0x10000 : 0x80000;

    const sorted = [...chips].sort((a, b) => a.offset - b.offset);
    const partitions = [];
    let current = null;

    for (const chip of sorted) {
      const factorySize = chip.chipInfo.factorySize || defaultFactorySize;
      if (!current || chip.offset >= current.start + current.size) {
        current = { start: chip.offset, size: factorySize, chips: [chip] };
        partitions.push(current);
      } else {
        current.chips.push(chip);
      }
    }

    console.log(`Найдено factory-партиций: ${partitions.length}`);
    return partitions;
  }

  function extractPartition(srcBuffer, partition) {
    const { start, size, chips } = partition;
    const src = new Uint8Array(srcBuffer);
    const out = new Uint8Array(size);

    const copyEnd = Math.min(start + size, src.length);
    out.set(src.subarray(start, copyEnd));

    if (chips.length >= 2) {
      const secondOff = chips[1].offset - start;
      if (secondOff !== SECOND_RADIO_OFFSET && secondOff > SECOND_RADIO_OFFSET) {
        console.log(`  Перенос 5GHz: 0x${secondOff.toString(16)} → 0x${SECOND_RADIO_OFFSET.toString(16)}`);
        const halfPart = size >> 1;
        const copyLen = Math.min(halfPart, size - secondOff);
        out.set(out.subarray(secondOff, secondOff + copyLen), SECOND_RADIO_OFFSET);
      }
    }

    return {
      data: new DataView(out.buffer),
      chipNames: chips.map(c => c.chipInfo.name),
      offset: start
    };
  }

  function deduplicate(eeproms) {
    function meaningfulLength(bytes) {
      let i = bytes.length - 1;
      while (i >= 0 && (bytes[i] === 0x00 || bytes[i] === 0xFF)) i--;
      return i + 1;
    }

    function isSameEeprom(a, b) {
      const aLen = meaningfulLength(a);
      const bLen = meaningfulLength(b);
      if (aLen !== bLen) return false;
      for (let i = 0; i < aLen; i++) {
        if (a[i] !== b[i]) return false;
      }
      return true;
    }

    return eeproms.filter((ep, i) => {
      const a = new Uint8Array(ep.data.buffer);
      for (let j = 0; j < i; j++) {
        const b = new Uint8Array(eeproms[j].data.buffer);
        if (isSameEeprom(a, b)) return false;
      }
      return true;
    });
  }

  function download(dataView, index, total) {
    const blob = new Blob([dataView], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = total > 1 ? `eeprom_${index + 1}.bin` : 'eeprom.bin';
    a.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById('file').addEventListener('change', async (evt) => {
    document.getElementById('info').style.display = 'none';
    document.getElementById('loadingContainer').style.display = 'none';
    document.getElementById('output').style.display = 'none';
    document.getElementById('output').innerHTML = 'Файл успешно сгенерирован<br />';
    document.getElementById('outputerror').style.display = 'none';
    document.getElementById('process').style.display = 'block';

    const file = evt.target.files[0];
    evt.target.value = '';
    const arrayBuffer = await file.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);

    console.log('=== EEPROM Cutter v2 ===');
    console.log(`Файл: ${file.name}, размер: ${data.length} байт (0x${data.length.toString(16)})`);

    const chips = findValidChips(data);
    const partitions = groupIntoPartitions(chips, data.length);
    const eeproms = partitions.map(p => extractPartition(arrayBuffer, p));
    const unique = deduplicate(eeproms);
    console.log(`Уникальных EEPROM: ${unique.length} из ${eeproms.length}`);

    document.getElementById('process').style.display = 'none';
    document.getElementById('loadingContainer').style.display = 'block';

    if (unique.length === 0) {
      document.getElementById('outputerror').style.display = 'block';
    } else {
      const outputEl = document.getElementById('output');
      outputEl.style.display = 'block';

      if (unique.length === 1) {
        const names = unique[0].chipNames.join(' / ');
        outputEl.innerHTML += `Найден чип: ${names}`;
        download(unique[0].data, 0, 1);
      } else {
        let html = 'Найдено несколько EEPROM:<br><br>';
        unique.forEach((ep, i) => {
          html += `eeprom_${i + 1}.bin: ${ep.chipNames.join(' / ')}<br>`;
        });
        if (unique.length < eeproms.length) {
          html += `<br>Пропущено дубликатов: ${eeproms.length - unique.length}`;
        }
        outputEl.innerHTML += html;
        unique.forEach((ep, i) => {
          setTimeout(() => download(ep.data, i, unique.length), 500 * i);
        });
      }
    }
  });
</script>

    <div><a href="https://yeezyio.github.io/">Вернуться на главную страницу</a></div>
  </body>
</html>
